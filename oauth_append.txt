
# OAuth endpoints for Slack app installation
@app.get("/slack/install")
async def slack_install():
    """Initiates the Slack OAuth 2.0 installation flow."""
    from app.config import config
    from fastapi.responses import RedirectResponse
    
    scopes = ["chat:write", "commands", "app_mentions:read", "channels:history", "groups:history", "im:history", "mpim:history"]
    oauth_url = f"https://slack.com/oauth/v2/authorize?client_id={config.SLACK_CLIENT_ID}&scope={','.join(scopes)}&user_scope="
    return RedirectResponse(url=oauth_url)


@app.get("/slack/install/callback")
async def slack_callback(request: Request, code: str = None, db: Session = Depends(get_db)):
    """Handles the Slack OAuth 2.0 redirect after app installation approval."""
    from app.config import config
    from slack_sdk.web import WebClient
    from app.models import SlackInstallation
    from fastapi.responses import RedirectResponse
    
    if not code:
        error = request.query_params.get("error", "No code received")
        logger.error(f"‚ùå OAuth failed: {error}")
        return JSONResponse(content={"message": f"Installation failed. Reason: {error}"}, status_code=400)

    try:
        client = WebClient()
        oauth_response = client.oauth_v2_access(client_id=config.SLACK_CLIENT_ID, client_secret=config.SLACK_CLIENT_SECRET, code=code)
        
        team_id = oauth_response["team"]["id"]
        team_name = oauth_response["team"]["name"]
        bot_token = oauth_response["access_token"]
        bot_user_id = oauth_response["bot_user_id"]
        
        logger.info(f"üîë Successfully installed in Team ID: {team_id} ({team_name})")
        
        installation = db.query(SlackInstallation).filter(SlackInstallation.team_id == team_id).first()
        
        if installation:
            installation.access_token = bot_token
            installation.bot_user_id = bot_user_id
            installation.team_name = team_name
            installation.installed_at = datetime.utcnow()
            logger.info(f"üîÑ Updated existing installation for {team_name}")
        else:
            installation = SlackInstallation(team_id=team_id, team_name=team_name, access_token=bot_token, bot_user_id=bot_user_id)
            db.add(installation)
            logger.info(f"‚ú® Created new installation for {team_name}")
            
        db.commit()
        return RedirectResponse(url=f"slack://app?team={team_id}")

    except Exception as e:
        logger.error(f"‚ùå OAuth Access Error: {e}", exc_info=True)
        db.rollback()
        raise HTTPException(status_code=500, detail="Failed to complete app installation.")
